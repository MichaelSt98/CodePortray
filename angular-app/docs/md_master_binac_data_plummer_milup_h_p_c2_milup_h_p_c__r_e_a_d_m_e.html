<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=9"/>
	<meta name="generator" content="Doxygen 1.9.3"/>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<title>milupHPC: milupHPC</title>
	<link href="tabs.css" rel="stylesheet" type="text/css"/>
	<script type="text/javascript" src="jquery.js"></script>
	<script type="text/javascript" src="dynsections.js"></script>
	<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
	<link href="doxygen-custom.css" rel="stylesheet" type="text/css" />
	<!-- Add icon library -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<!-- Add font awesome icons -->
</head>
<body>
	<div id="banner">
		<div class="logo">
			<span class="subtitle">
				milupHPC documentation <!-- milupHPC -->
			</span>
			<!-- <span class="search">
				<input type="text" placeholder="Search" onkeydown="search(this,event);">
			</span> -->
		</div>
	<div class="icon-bar">
		<a href="https://www.tat.physik.uni-tuebingen.de/~schaefer/#codes" class="fa fa-university"></a>
		<a href="https://github.com/MichaelSt98/milupHPC" class="fa fa-github"></a>
		<a href="https://en.wikipedia.org/wiki/Smoothed-particle_hydrodynamics" class="fa fa-wikipedia-w"></a>
	</div>
	</div>
	<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">milupHPC </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><b>High Performance Computing Smooth(ed) <a class="el" href="class_particle.html">Particle</a> Hydrodynamics</b></p>
<p >The successor of <a href="https://github.com/christophmschaefer/miluphcuda">miluphcuda</a> targeting GPU cluster via CUDA aware MPI.</p>
<hr  />
<p >This repository aims to implement a <b>Multi-GPU SPH/NBody algorithm using CUDA aware MPI</b> by combining ideas from:</p>
<ul>
<li><b>Single-GPU version inspired/adopted from:</b><ul>
<li><a href="https://github.com/christophmschaefer/miluphcuda">Miluphcuda</a></li>
<li><a href="https://iss.oden.utexas.edu/Publications/Papers/burtscher11.pdf">An Efficient CUDA Implementation of the Tree-Based Barnes Hut n-Body Algorithm</a></li>
<li><a href="https://github.com/MichaelSt98/NNS/tree/main/3D/CUDA/CUDA_NBody">Implementation: MichaelSt98/NNS</a> CUDA_NBody</li>
</ul>
</li>
<li><b>Multi-Node (or rather Multi-CPU) version inspired/adopted from:</b><ul>
<li>M. Griebel, S. Knapek, and G. Zumbusch. Numerical Simulation in Molecular Dynamics: Numerics, Algorithms, Parallelization, Applications. 1st. Springer Pub- lishing Company, Incorporated, 2010. isbn: 3642087760</li>
<li><a href="https://github.com/MichaelSt98/NNS/tree/MolecularDynamics/MolecularDynamics/BarnesHutParallel">Implementation: MichaelSt98/NNS (branch: MolecularDynamics)</a></li>
</ul>
</li>
</ul>
<hr  />
<ul>
<li>See <a href="https://github.com/MichaelSt98/SPH">MichaelSt98/SPH</a> for a proof of concept</li>
</ul>
<h1><a class="anchor" id="autotoc_md470"></a>
Usage</h1>
<blockquote class="doxtable">
<p >&zwj;you need to provide an appropriate H5 file as initial (particle) distribution</p>
<ul>
<li>see <a href="https://github.com/MichaelSt98/ParticleDistributor">GitHub: ParticleDistributor</a> </li>
</ul>
</blockquote>
<ul>
<li><b>compile</b> using the <em>Makefile</em> via: <code>make</code><ul>
<li>for debug: <code>make debug</code><ul>
<li>using <em>cuda-gdb</em>: <code>./debug/cuda_debug.sh</code></li>
</ul>
</li>
<li>for single-precision: <code>make single-precision</code> (default: double-precision)</li>
</ul>
</li>
<li><b>run</b> via: <code>mpirun -np &lt;number of processes&gt; ./bin/runner -f &lt;filename&gt;</code><ul>
<li>e.g.: <code>mpirun -np 2 ./bin/runner -f examples/kepler.h5</code></li>
</ul>
</li>
<li>clean via: <code>make clean</code>, <code>make cleaner</code></li>
<li>rebuild via: <code>make remake</code> <br  />
</li>
</ul>
<h2><a class="anchor" id="autotoc_md471"></a>
Relevant preprocessor directives</h2>
<ul>
<li>adjust in <em>include/parameters.h</em> and rebuild</li>
</ul>
<div class="fragment"><div class="line"><span class="preprocessor">#define DEBUGGING 0</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define SAFETY_LEVEL 2</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define DIM 3</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define SI_UNITS 1</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define CUBIC_DOMAINS 1</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define GRAVITY_SIM 1</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define SPH_SIM 1</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define INTEGRATE_ENERGY 0</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define INTEGRATE_DENSITY 1</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define INTEGRATE_SML 0</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define DECOUPLE_SML 0</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define VARIABLE_SML 1</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define SML_CORRECTION 0</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define SPH_EQU_VERSION 1</span></div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md472"></a>
Config file settings</h2>
<div class="fragment"><div class="line">; IO RELATED</div>
<div class="line">; ------------------------------------------------------</div>
<div class="line">; output directory (will be created if it does not exist)</div>
<div class="line">directory bb/</div>
<div class="line"> </div>
<div class="line">; outputRank (-1 corresponds to all)</div>
<div class="line">outputRank -1</div>
<div class="line">; omit logType::TIME for standard output</div>
<div class="line">omitTime true</div>
<div class="line">; create log file (including warnings, errors, ...)</div>
<div class="line">log true</div>
<div class="line">; create performance log</div>
<div class="line">performanceLog true</div>
<div class="line">; write particles to be sent to h5 file</div>
<div class="line">particlesSent2H5 true</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">; INTEGRATOR RELATED</div>
<div class="line">; ------------------------------------------------------</div>
<div class="line">; integrator selection</div>
<div class="line">; explicit euler [0], predictor-corrector euler [1]</div>
<div class="line">integrator 1</div>
<div class="line">; initial time step</div>
<div class="line">timeStep 1e-4</div>
<div class="line">; max time step allowed</div>
<div class="line">maxTimeStep 1e9</div>
<div class="line">; end time for simulation</div>
<div class="line">;timeEnd 1.0</div>
<div class="line">;timeEnd 5.0e7</div>
<div class="line">timeEnd 6.9e11</div>
<div class="line">;timeEnd 0.5e10;</div>
<div class="line">;timeEnd 1e12</div>
<div class="line">;timeEnd 6e-2</div>
<div class="line"> </div>
<div class="line">; SIMULATION RELATED</div>
<div class="line">; ------------------------------------------------------</div>
<div class="line">; space-filling curve selection</div>
<div class="line">; lebesgue [0], hilbert [1]</div>
<div class="line">sfc 1</div>
<div class="line"> </div>
<div class="line">; theta-criterion for Barnes-Hut (approximative gravity)</div>
<div class="line">theta 0.5</div>
<div class="line">; smoothing parameter for gravitational forces</div>
<div class="line">;smoothing 0.025</div>
<div class="line">;smoothing 3.0e12</div>
<div class="line">;smoothing 1.6e13</div>
<div class="line">;smoothing 3.2e13</div>
<div class="line">smoothing 2.56e+20</div>
<div class="line"> </div>
<div class="line">; SPH smoothing kernel selection</div>
<div class="line">; spiky [0], cubic spline [1], wendlandc2 [3], wendlandc4 [4], wendlandc6 [5]</div>
<div class="line">smoothingKernel 1</div>
<div class="line"> </div>
<div class="line">; remove particles (corresponding to some criterion)</div>
<div class="line">removeParticles true</div>
<div class="line">; spherically [0], cubic [1]</div>
<div class="line">removeParticlesCriterion 0</div>
<div class="line">; allowed distance to center (0, 0, 0)</div>
<div class="line">;removeParticlesDimension 1.0</div>
<div class="line">removeParticlesDimension 3.6e14</div>
<div class="line"> </div>
<div class="line">; execute load balancing</div>
<div class="line">loadBalancing false</div>
<div class="line">; interval for executing load balancing (every Nth step)</div>
<div class="line">loadBalancingInterval 1</div>
<div class="line">; amount of bins for load balancing</div>
<div class="line">loadBalancingBins 2000</div>
<div class="line"> </div>
<div class="line">; how much memory to allocate (1.0 -&gt; all particles can in principle be on one process)</div>
<div class="line">particleMemoryContingent 1.0</div>
<div class="line"> </div>
<div class="line">; calculate angular momentum (and save to output file)</div>
<div class="line">calculateAngularMomentum true</div>
<div class="line">; calculate (total) energy (and save to output file)</div>
<div class="line">calculateEnergy true</div>
<div class="line">; calculate center of mass (and save to output file)</div>
<div class="line">calculateCenterOfMass false</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md473"></a>
Command line arguments</h2>
<ul>
<li><code>./bin/runner -h</code> gives help:</li>
</ul>
<div class="fragment"><div class="line">Multi-GPU CUDA Barnes-Hut NBody/SPH code</div>
<div class="line">Usage:</div>
<div class="line">  HPC NBody [OPTION...]</div>
<div class="line"> </div>
<div class="line">  -n, --number-output-files arg</div>
<div class="line">                                number of output files (default: 100)</div>
<div class="line">  -t, --max-time-step arg       time step (default: -1.)</div>
<div class="line">  -l, --load-balancing          load balancing</div>
<div class="line">  -L, --load-balancing-interval arg</div>
<div class="line">                                load balancing interval (default: -1)</div>
<div class="line">  -C, --config arg              config file (default: config/config.info)</div>
<div class="line">  -m, --material-config arg     material config file (default: </div>
<div class="line">                                config/material.cfg)</div>
<div class="line">  -c, --curve-type arg          curve type (Lebesgue: 0/Hilbert: 1) </div>
<div class="line">                                (default: -1)</div>
<div class="line">  -f, --input-file arg          File name (default: -)</div>
<div class="line">  -v, --verbosity arg           Verbosity level (default: 0)</div>
<div class="line">  -h, --help                    Show this help</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md474"></a>
Test cases</h1>
<ul>
<li>some samples:<ul>
<li>each color represents a process, thus a GPU</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md475"></a>
Kepler</h2>
<ul>
<li>Kepler disk: four GPUs (hilbert curve)</li>
</ul>
<p ><img src="documents/kepler_hilbert_4proc.gif" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md476"></a>
Plummer</h2>
<ul>
<li>Plummer model: four GPUs with dynamic load balancing every 10th step (top: lebesgue, bottom: hilbert)</li>
</ul>
<p ><img src="documents/4proc_plummer_dynamic.gif" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md477"></a>
Sedov</h2>
<ul>
<li>Sedov explosion: one and two GPUs</li>
</ul>
<p ><img src="documents/sedov_sample_movie.gif" alt="" class="inline"/></p>
<h2><a class="anchor" id="autotoc_md478"></a>
Boss-Bodenheimer: isothermal collapse</h2>
<ul>
<li>Boss-Bodenheimer: isothermal collapse<ul>
<li>one and two GPUs</li>
</ul>
</li>
</ul>
<p ><img src="documents/bb_sample_movie.gif" alt="" class="inline"/></p>
<h1><a class="anchor" id="autotoc_md479"></a>
Implementation</h1>
<h2><a class="anchor" id="autotoc_md480"></a>
Multi-CPU version</h2>
<p >See:</p>
<blockquote class="doxtable">
<p >&zwj;M. Griebel, S. Knapek, and G. Zumbusch. <b>Numerical Simulation in Molecular Dynamics</b>: Numerics, Algorithms, Parallelization, Applications. 1st. Springer Pub- lishing Company, Incorporated, 2010. isbn: 3642087760 </p>
</blockquote>
<p>within the following sections:</p>
<ul>
<li>8 <a class="el" href="class_tree.html">Tree</a> Algorithms for Long-Range Potentials</li>
<li>8.1 Series Expansion of the Potential</li>
<li>8.2 <a class="el" href="class_tree.html">Tree</a> Structures for the Decomposition of the Far Field</li>
<li>8.3 Particle-Cluster Interactions and the Barnes-Hut Method<ul>
<li>8.3.1 Method</li>
<li>8.3.2 Implementation</li>
<li>8.3.3 Applications from Astrophysics</li>
</ul>
</li>
<li>8.4 <b>ParallelTreeMethods</b><ul>
<li>8.4.1 <b>An Implementation with Keys</b></li>
<li>8.4.2 <b>Dynamical Load Balancing</b></li>
<li>8.4.3 <b>Data Distribution with Space-Filling Curves</b></li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md481"></a>
Single-GPU implementation</h2>
<h3><a class="anchor" id="autotoc_md482"></a>
Miluphcuda</h3>
<ul>
<li>See <a href="https://github.com/christophmschaefer/miluphcuda">GitHub: Miluphcuda</a></li>
</ul>
<h3><a class="anchor" id="autotoc_md483"></a>
An Efficient CUDA Implementation of the Tree-Based Barnes Hut n-Body Algorithm</h3>
<p >See <a href="https://iss.oden.utexas.edu/Publications/Papers/burtscher11.pdf">An Efficient CUDA Implementation of the Tree-Based Barnes Hut n-Body Algorithm</a>, which describes a CUDA implementation of the classical Barnes Hut n-body algorithm that runs entirely on the GPU. The code builds an irregular treebased data structure and performs complex traversals on it.</p>
<p ><b>The Barnes Hut algorithm is challenging to implement efficiently in CUDA, since</b></p>
<ol type="1">
<li>it repeatedly builds and traverse an irregular tree-based data structure</li>
<li>performs a lot of pointer-chasing memory operatons</li>
<li>is tipically expressed recursively, which is not supported by current GPUs</li>
<li>traversing irregular data structures often results in thread divergence</li>
</ol>
<p ><b>Possible solutions to these problems</b></p>
<ul>
<li>iterations instead of recursion</li>
<li>load instructions, caching, and throttling threads to drastically reduce the number of main memory accesses</li>
<li>employing array-based techniques to enable some coalescing</li>
<li>grouping similar work together to minimize divergence</li>
</ul>
<p ><b>Exploit some unique archtictural features of nowadays GPUs:</b></p>
<ul>
<li>threads in a warp necessarily run in lockstep, having one thread fetch data from main memory and share the data with the other threads without the need for synchronization</li>
<li>barriers are implemented in hardware on GPUs and are therefore very fast, therefore it is possible to utilize them to reduce wasted work and main memory accesses in a way that is impossible in current CPUs where barriers have to communicate through memory</li>
<li>GPU-specific operations such as thread-voting functions to greatly improve performance and make use of fence instructions to implement lightweight synchronization without atomic operations</li>
</ul>
<h3><a class="anchor" id="autotoc_md484"></a>
Mapping Barnes Hut algoirthm to GPU kernels</h3>
<p ><b>High-level steps:</b></p>
<ul>
<li>[CPU] Reading input data and transfer to GPU</li>
<li><em>For each timestep do:</em><ul>
<li>[GPU] compute bounding box around all bodies</li>
<li>[GPU] build hierarchical decomposition by inserting each body into an octree</li>
<li>[GPU] summarize body information in each internal octree node</li>
<li>[GPU] approximately sort the bodies by spatial distance</li>
<li>[GPU] compute forces acting on each body with help of octree</li>
<li>[GPU] update body positions and velocities</li>
<li>([CPU] Transfer result to CPU and output)</li>
</ul>
</li>
<li>[CPU] Transfer result to CPU and output</li>
</ul>
<h4><a class="anchor" id="autotoc_md485"></a>
Global optimzations</h4>
<p >Global optimizations, meaning optimizations and implementations applying to all Kernels.</p>
<ul>
<li>Because dynamic allocation of and accesses to heap objects tend to be slow, an <b>array-based data structure</b> is used</li>
<li>Accesses to arrays cannot be coalesced if the array elements are objects with multiple fields, so several aligned scalar arrays, one per field are used<ul>
<li>thus, array indexes instead of pointers to tree nodes</li>
</ul>
</li>
<li>to simplify and speed up the code, it is important to use the same arrays for both bodies and cells</li>
<li>allocate the bodies at the beginning and the cells at the end of the arrays, and use an index of −1 as a “null pointer”<ul>
<li>a simple comparison of the array index with the number of bodies determines whether the index points to a cell or a body</li>
<li>it is possible to alias arrays that hold only cell information with arrays that hold only body information to reduce the memory consumption while maintaining a one-to-one correspondence between the indexes into the different arrays</li>
</ul>
</li>
<li>the thread count per block is maximized and rounded down to the nearest multiple of the warp size for each kernel</li>
<li>all kernels use at least as many blocks as there are streaming multiprocessors in the GPU, which is automatically detected</li>
<li>all parameters passed to the kernels, such as the starting addresses of the various arrays, stay the same throughout the time step loop, so that they can be copied once into the GPU’s constant memory</li>
<li>the code operates on octrees in which nodes can have up to eight children, it contains many loops with a trip count of eight. Therefore the loops are unrolled (e.g. by pragmas or compiler optimization)</li>
</ul>
<h4><a class="anchor" id="autotoc_md486"></a>
Kernel 1: computes bounding box around all bodies</h4>
<p ><a class="el" href="namespace_kernel.html">Kernel</a> 1 computes the bounding box around all bodies, whic becomes the root node (outermost cell) of the octree.</p>
<h4><a class="anchor" id="autotoc_md487"></a>
Kernel 2: hierachically subdivides the root cells</h4>
<p ><a class="el" href="namespace_kernel.html">Kernel</a> 2 hierarchically subdivides this cell until there is at most one body per innermost cell. This is accomplished by inserting all bodies into the octree.</p>
<h4><a class="anchor" id="autotoc_md488"></a>
Kernel 3: computes the COM for each cell</h4>
<p ><a class="el" href="namespace_kernel.html">Kernel</a> 3 computes, for each cell, the center of gravity and the cumulative mass of all contained bodies.</p>
<h4><a class="anchor" id="autotoc_md489"></a>
Kernel 4: sorts the bodies</h4>
<p ><a class="el" href="namespace_kernel.html">Kernel</a> 4 sorts the bodies according to an in-order traversal of the octree, which typically places spatially close bodies close together</p>
<h4><a class="anchor" id="autotoc_md490"></a>
Kernel 5: computes the forces</h4>
<p ><a class="el" href="namespace_kernel.html">Kernel</a> 5 computes the forces acting on each body. Starting from the octree’s root, it checks whether the center of gravity is far enough away from the current body for each encountered cell. If it is not, the subcells are visited to perform a more accurate force calculation, if it is, only one force calculation with the cell’s center of gravity and mass is performed, and the subcells and all bodies within them are not visited, thus greatly reducing the total number of force calculations.</p>
<p ><b>The fifth kernel requires the vast majority of the runtime and is therefore the most important to optimize.</b></p>
<p >For each body, the corresponding thread traverses some prefix of the octree to compute the force acting upon this body.</p>
<h4><a class="anchor" id="autotoc_md491"></a>
Kernel 6: updates the bodies</h4>
<p ><a class="el" href="namespace_kernel.html">Kernel</a> 6 nudges all the bodies into their new positions and updates their velocities. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
  <hr class="footer"/><address class="footer"><small>
    milupHPC  - milupHPC<br />
    Generated on Tue Jan 11 2022 17:43:18 by <a href="http://www.doxygen.org/index.html">Doxygen</a> 1.9.3
  </small></address>
</body>
</html>